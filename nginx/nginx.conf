worker_processes 1; # 1ê°œì˜ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‚¬ìš©

events {
    worker_connections 1024; # ê° ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì—°ê²° ìˆ˜ë¥¼ 1024ë¡œ ì„¤ì •
}

http {

    include /etc/nginx/mime.types;
    
    upstream backend {
        server backend:8080; # backend : ë„ì»¤ì»´í¬ì¦ˆ ì„œë¹„ìŠ¤ëª…
    }

    server {
        listen 80; # í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ë°›ì„ í¬íŠ¸ ì„¤ì •

        # ê¸°ë³¸ ë£¨íŠ¸ ê²½ë¡œì™€ ì¸ë±ìŠ¤ íŒŒì¼ì„ ì„¤ì •
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # '/api/'ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ë°±ì—”ë“œ ì„œë²„ë¡œ í”„ë¡ì‹œí•˜ë„ë¡ ì„¤ì •
        location /api/ {
            proxy_pass https://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # ğŸ”¥ ì¶”ê°€í•  ì„¤ì • (DELETE/POST ìš”ì²­ ì˜¤ë¥˜ ë°©ì§€)
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";
            proxy_http_version 1.1;
        }

        # SSE(Server-Sent Events) ì„¤ì • ì¶”ê°€
        location /api/notifications/subscribe/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # ğŸ”¥ SSEë¥¼ ìœ„í•œ íƒ€ì„ì•„ì›ƒ ë° ì»¤ë„¥ì…˜ ì„¤ì •
            proxy_buffering off;  # SSEëŠ” ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì „ì†¡ì´ë¯€ë¡œ ë²„í¼ë§ ë¹„í™œì„±í™”
            proxy_read_timeout 3600s;  # íƒ€ì„ì•„ì›ƒì„ 1ì‹œê°„ìœ¼ë¡œ ì„¤ì •
            proxy_connect_timeout 60s;  # ì—°ê²° íƒ€ì„ì•„ì›ƒ 60ì´ˆ
            proxy_send_timeout 60s;  # ìš”ì²­ ì „ì†¡ íƒ€ì„ì•„ì›ƒ 60ì´ˆ

            add_header X-Accel-Buffering no;  # Nginxì˜ ìì²´ ë²„í¼ë§ ë°©ì§€ (SSE í•„ìˆ˜)
            add_header Cache-Control no-cache;  # í´ë¼ì´ì–¸íŠ¸ê°€ ìºì‹±í•˜ì§€ ì•Šë„ë¡ ì„¤ì •

            # SSEì—ì„œëŠ” HTTP/1.1ì´ í•„ìš”
            proxy_http_version 1.1;
        }
    }
}